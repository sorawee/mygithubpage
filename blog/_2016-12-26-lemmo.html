<html>
<head>
  <meta charset="UTF-8">
  <title>
    Lemmo — Sorawee's Website
  </title>
  <link href="https://afeld.github.io/emoji-css/emoji.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" media="all" href="../css/styles.css" />
  <link rel="stylesheet" type="text/css" media="all" href="../css/normalize.css" />
  <link rel="stylesheet" type="text/css" media="all" href="../css/styles-github.css" />
  <script type="text/javascript"
    src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_CHTML">
  </script>
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});
  </script>
  <style type="text/css">.highlight .hll { background-color: #ffffcc }
.highlight  { background: #f8f8f8; }
.highlight .c { color: #408080; font-style: italic } /* Comment */
.highlight .err { border: 1px solid #FF0000 } /* Error */
.highlight .k { color: #008000; font-weight: bold } /* Keyword */
.highlight .o { color: #666666 } /* Operator */
.highlight .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #BC7A00 } /* Comment.Preproc */
.highlight .c1 { color: #408080; font-style: italic } /* Comment.Single */
.highlight .cs { color: #408080; font-style: italic } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0044DD } /* Generic.Traceback */
.highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #008000 } /* Keyword.Pseudo */
.highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #B00040 } /* Keyword.Type */
.highlight .m { color: #666666 } /* Literal.Number */
.highlight .s { color: #BA2121 } /* Literal.String */
.highlight .na { color: #7D9029 } /* Name.Attribute */
.highlight .nb { color: #008000 } /* Name.Builtin */
.highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.highlight .no { color: #880000 } /* Name.Constant */
.highlight .nd { color: #AA22FF } /* Name.Decorator */
.highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0000FF } /* Name.Function */
.highlight .nl { color: #A0A000 } /* Name.Label */
.highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */
.highlight .nv { color: #19177C } /* Name.Variable */
.highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mf { color: #666666 } /* Literal.Number.Float */
.highlight .mh { color: #666666 } /* Literal.Number.Hex */
.highlight .mi { color: #666666 } /* Literal.Number.Integer */
.highlight .mo { color: #666666 } /* Literal.Number.Oct */
.highlight .sb { color: #BA2121 } /* Literal.String.Backtick */
.highlight .sc { color: #BA2121 } /* Literal.String.Char */
.highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.highlight .s2 { color: #BA2121 } /* Literal.String.Double */
.highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */
.highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.highlight .sx { color: #008000 } /* Literal.String.Other */
.highlight .sr { color: #BB6688 } /* Literal.String.Regex */
.highlight .s1 { color: #BA2121 } /* Literal.String.Single */
.highlight .ss { color: #19177C } /* Literal.String.Symbol */
.highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */
.highlight .vc { color: #19177C } /* Name.Variable.Class */
.highlight .vg { color: #19177C } /* Name.Variable.Global */
.highlight .vi { color: #19177C } /* Name.Variable.Instance */
.highlight .il { color: #666666 } /* Literal.Number.Integer.Long */</style>
</head>
<body>
  <nav><ul>

    <li><a href="../">&uarr; Home</a></li>

    <li>
      <a href="_2016-12-26-lemmo.pdf">
        <img src="../css/pdficon.png" width="15" height="15" alt="Download PDF" />
        <span class="caps" style="font-style: normal">PDF</span>
      </a>
    </li>
    <li style="width: auto;">
      <a href="_2016-12-26-lemmo.pollen.html" title="View the Pollen source for this file"
         class="sourcelink code">&loz; Pollen Source
      </a>
    </li>
  </ul></nav>
  <section class="page-header">
    <h1 class="project-name">
      <a href="../">Sorawee's Website</a>
    </h1>
    <h2 class="project-tagline"></h2>
    <a href="../" class="btn">Blog</a>
    <a href="../books.html" class="btn">Books</a>
    <a href="../feed.xml" class="btn">RSS</a>
    <a href="../about.html" class="btn">About Me</a>
  </section>
  <section class="main-content">
  <!><h1>Lemmo</h1><!><p class="tags">Tags: <a href="/tags/competition">competition</a>, <a href="/tags/programming">programming</a></p><p class="pubdate">Published on Monday, December 26th, 2016</p><div class="content"><!><p>This post is written as a tribute to <i><a href="https://en.wikipedia.org/wiki/Lemmings_(video_game)"><!>Lemmings</!></a></i>, a popular game released 26 years ago.</p><p>I personally never play <i>Lemmings</i>, though I have played its open-source clone, <i><a href="https://pingus.seul.org"><!>Pingus</!></a></i><!><label for="fffdeaa1-12f7-4481-b8d9-2b5a1933bafc" class="margin-toggle sidenote-number"></label><input type="checkbox" id="fffdeaa1-12f7-4481-b8d9-2b5a1933bafc" class="margin-toggle"/><span class="sidenote">I in fact have devised a pretty good (if not optimal) <a href="https://www.youtube.com/watch?v=Wdl9bBUmU-k"><!>strategy</!></a> for a level four years ago</span></!>. Anyway, this post is not really about the game. Rather, I would like to write about my favorite programming competition problem involving <i>Lemmo</i>, a variant of <i>Lemmings</i><!><label for="4aaf69fd-f6c6-40f1-8ba8-1c5f59efe451" class="margin-toggle sidenote-number"></label><input type="checkbox" id="4aaf69fd-f6c6-40f1-8ba8-1c5f59efe451" class="margin-toggle"/><span class="sidenote">Here is the <a href="http://theory.cpe.ku.ac.th/~pramook/ioi/2011/oct12_lemmo.pdf"><!>original problem statement</!></a> (in Thai)</span></!>.</p><p>Lemmo is a simple creature. All it does is merely walking. When hitting a wall, it turns around. When stepping over a space, it falls. It is guaranteed that the map will have at least a space for every non-first floor. That is, the Lemmo will definitely reach the first floor. The game ends when the Lemmo steps over either a treasure box or a bottomless sewer drain, located on the first floor. As you can anticipate, finding a treasure box is a win, while falling into a bottomless sewer drain is a lose. It is also guaranteed that there will be at least one treasure box or one sewer drain, and that there is no space on the first floor. That is, the game will always end.</p><p>Let <mathjax>$r, c$</mathjax> be the number of rows and columns of the map respectively. Initially, the Lemmo could be in <mathjax>$c$</mathjax> different positions, and it is either facing to the left or facing to the right. Therefore, there are <mathjax>$2c$</mathjax> initial configurations.</p><p><button id="start">Start</button> <button id="stop">Stop</button> <button id="reset">Reset</button></p><canvas id="game" width="560" height="200"></canvas><p><script>// 0 is empty
// 1 is normal
// 2 is treasure
// 3 is sewer
const map = [
  [1,1,1,1,1,0,1,1,1,0,1,1],
  [1,1,1,0,1,1,1,1,1,0,1,1],
  [1,0,1,1,1,1,0,1,1,1,1,1],
  [3,1,1,2,1,1,1,1,1,1,1,1]
];
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const rows = map.length;
const cols = map[0].length;
const height_gap = 30;
const width_gap = 25;
const center_width = width_gap / 2;
const center_height = 12;
const margin_left = 10;
const margin_top = 10;
const color_white = "#FFFFFF";
const color_yellow = "#CCCC00";
const color_red = "#FF0000";
const color_black = "#000000";
const color_blue = "#0095DD";
let pos_x = 0;
let pos_y = 0;
let dir = 1;
const radius_ball = 10;

function get_x(x) {
  return x * width_gap + margin_left;
}

function get_y(x) {
  return x * height_gap + margin_top;
}

let intv = null;
let setup_step = true;

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  for (var i = 0; i < rows; ++i) {
    for (var j = 0; j < cols; ++j) {
      if (map[i][j] > 0) {
        ctx.beginPath();
        ctx.rect(get_x(j), get_y(i) + ((height_gap * 4) / 5), width_gap - 1, height_gap / 5);
        ctx.fillStyle = color_red;
        ctx.fill();
        ctx.closePath();
        let color = color_white;
        if (map[i][j] == 1) {
          color = color_white;
        } else if (map[i][j] == 2) {
          color = color_yellow;
        } else if (map[i][j] == 3) {
          color = color_black;
        } else {
          throw new Error("Incorrect map value");
        }
        ctx.beginPath();
        ctx.arc(get_x(j) + center_width, get_y(i) + center_height, 9, 0, Math.PI*2);
        ctx.fillStyle = color;
        ctx.fill();
        ctx.closePath();
      }
    }
  }
  ctx.beginPath();
  if (dir == 1) {
    ctx.moveTo(get_x(pos_x) + 5, get_y(pos_y) + 5);
    ctx.lineTo(get_x(pos_x) + 5, get_y(pos_y) + 19);
    ctx.lineTo(get_x(pos_x) + width_gap - 5, get_y(pos_y) + center_height);
  } else if (dir == -1) {
    ctx.moveTo(get_x(pos_x) + width_gap - 5, get_y(pos_y) + 5);
    ctx.lineTo(get_x(pos_x) + width_gap - 5, get_y(pos_y) + 19);
    ctx.lineTo(get_x(pos_x) + 5, get_y(pos_y) + center_height);
  } else {
    throw new Error("dir is not 1 or -1");
  }
  ctx.fillStyle = color_blue;
  ctx.fill();
  ctx.closePath();
}

draw();

function act() {
  draw();
  if (map[pos_y][pos_x] == 0) {
    pos_y += 1;
  } else if (map[pos_y][pos_x] == 1) {
    pos_x += dir;
    if (pos_x < 0) {
      pos_x = 0;
      dir *= -1;
    }
    if (pos_x > cols - 1) {
      pos_x = cols - 1;
      dir *= -1;
    }
  } else {
    clearInterval(intv);
  }
}

function start_fun() {
  setup_step = false;
  if (intv == null) {
    intv = setInterval(act, 300);
  }
}

function stop_fun() {
  if (intv != null) {
    clearInterval(intv);
    intv = null;
  }
}

function reset_fun() {
  stop_fun();
  setup_step = true;
  pos_x = 0;
  pos_y = 0;
  dir = 1;
  draw();
}

document.getElementById("start").onclick = start_fun;
document.getElementById("stop").onclick = stop_fun;
document.getElementById("reset").onclick = reset_fun;

document.addEventListener("keydown", function(e) {
  if (!setup_step) return;
  if(e.keyCode == 90) dir = -1;
  if(e.keyCode == 88) dir = 1;
  if(e.keyCode == 39) pos_x = Math.min(pos_x + 1, cols - 1);
  if(e.keyCode == 37) pos_x = Math.max(pos_x - 1, 0);
  draw();
}, false);</script></p><p><i>Use the following keys to setup the initial configuration: <!><kbd>Left</kbd></!> to move left, <!><kbd>Right</kbd></!> to move right, <!><kbd>z</kbd></!> to face to the left, <!><kbd>x</kbd></!> to face to the right. Then click <code>Start</code> to begin the game.</i></p><p>Task 1: Write a program to find how many initial configurations will lead the Lemmo to a treasure box?</p><p>Task 2: Write a program to find how many initial configurations will lead the Lemmo to a treasure box, provided that you are allowed to remove no more than one block in a floor (that is, turning no more than one block into a space)?</p><p>The input will be in the following format:</p><div class="highlight"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="source"><pre><span></span>#####.###.##
###.#####.##
#.####.#####
@##$########
</pre></div></td></tr></tbody></table></div><p>where <code>@</code> indicates a bottomless sewer drain, <code>#</code> indicates a block on a floor, <code>.</code> indicates a space, and <code>$</code> indicates a treasure box.</p><p>In the above example, the configurations facing left in the column 6, 7, 8, 9 will lead to a bottomless sewer drain, while the rest will lead to a treasure box. However, if we remove the block at row 3, column 4, all configurations will lead to a treasure box.</p><p>Following is my solution: <!><label for="3854ec16-d6e2-4b42-bc63-b2f8836b9934" class="fold-toggle">[spoiler ⊕]</label><input type="checkbox" id="3854ec16-d6e2-4b42-bc63-b2f8836b9934" class="fold-toggle"/><span class="folded-content"><mathjax>$O(rc)$</mathjax>-dynamic programming</span></!></p><div class="highlight"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111</pre></div></td><td class="code"><div class="source"><pre><span></span><span class="kn">#lang </span><span class="nn">racket</span>

<span class="p">(</span><span class="k">define</span> <span class="n">SPACE</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">(</span><span class="k">define</span> <span class="n">BLOCK</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">(</span><span class="k">define</span> <span class="n">WIN</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">(</span><span class="k">define</span> <span class="n">LOSE</span> <span class="mi">3</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="n">transform</span> <span class="n">x</span><span class="p">)</span>
  <span class="p">(</span><span class="k">match</span> <span class="n">x</span>
    <span class="p">[</span><span class="sc">#\.</span> <span class="n">SPACE</span><span class="p">]</span>
    <span class="p">[</span><span class="sc">#\#</span> <span class="n">BLOCK</span><span class="p">]</span>
    <span class="p">[</span><span class="sc">#\$</span> <span class="n">WIN</span><span class="p">]</span>
    <span class="p">[</span><span class="sc">#\@</span> <span class="n">LOSE</span><span class="p">]))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="n">memoize</span> <span class="n">f</span><span class="p">)</span>
  <span class="p">(</span><span class="k">define</span> <span class="n">mem</span> <span class="p">(</span><span class="nb">make-hash</span><span class="p">))</span>
  <span class="p">(</span><span class="k">lambda</span> <span class="n">args</span> <span class="p">(</span><span class="nb">hash-ref!</span> <span class="n">mem</span> <span class="n">args</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">()</span> <span class="p">(</span><span class="nb">apply</span> <span class="n">f</span> <span class="n">args</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="n">calc</span> <span class="n">lines</span><span class="p">)</span>
  <span class="p">(</span><span class="k">define</span> <span class="n">table</span>
    <span class="p">(</span><span class="nb">list-&gt;vector</span>
     <span class="p">(</span><span class="nb">append</span>
      <span class="p">(</span><span class="nb">list</span> <span class="p">(</span><span class="nb">build-vector</span> <span class="p">(</span><span class="nb">string-length</span> <span class="p">(</span><span class="nb">first</span> <span class="n">lines</span><span class="p">))</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="k">_</span><span class="p">)</span> <span class="n">SPACE</span><span class="p">)))</span>
      <span class="p">(</span><span class="nb">map</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="p">(</span><span class="nb">list-&gt;vector</span> <span class="p">(</span><span class="nb">map</span> <span class="n">transform</span> <span class="p">(</span><span class="nb">string-&gt;list</span> <span class="n">line</span><span class="p">))))</span> <span class="n">lines</span><span class="p">))))</span>
  <span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="n">normalize</span> <span class="n">x</span><span class="p">)</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">zero?</span> <span class="n">x</span><span class="p">)</span> <span class="mi">0</span> <span class="mi">1</span><span class="p">))</span>
  <span class="p">(</span><span class="k">define</span> <span class="n">table-sum</span>
    <span class="p">(</span><span class="nb">vector-map</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="n">row-vector</span><span class="p">)</span>
                  <span class="p">(</span><span class="k">define-values</span> <span class="p">(</span><span class="k">_</span> <span class="n">lst</span><span class="p">)</span>
                    <span class="p">(</span><span class="k">for/fold</span> <span class="p">([</span><span class="n">sum</span> <span class="mi">0</span><span class="p">]</span> <span class="p">[</span><span class="n">lst</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">0</span><span class="p">)])</span> <span class="p">([</span><span class="n">e</span> <span class="n">row-vector</span><span class="p">])</span>
                      <span class="p">(</span><span class="nb">values</span> <span class="p">(</span><span class="nb">+</span> <span class="n">sum</span> <span class="p">(</span><span class="n">normalize</span> <span class="n">e</span><span class="p">))</span> <span class="p">(</span><span class="nb">cons</span> <span class="p">(</span><span class="nb">+</span> <span class="n">sum</span> <span class="n">e</span><span class="p">)</span> <span class="n">lst</span><span class="p">))))</span>
                  <span class="p">(</span><span class="nb">list-&gt;vector</span> <span class="p">(</span><span class="nb">reverse</span> <span class="n">lst</span><span class="p">)))</span>
                <span class="n">table</span><span class="p">))</span>
  <span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="n">lookup</span> <span class="n">i</span> <span class="n">j</span><span class="p">)</span> <span class="p">(</span><span class="nb">vector-ref</span> <span class="p">(</span><span class="nb">vector-ref</span> <span class="n">table</span> <span class="n">i</span><span class="p">)</span> <span class="n">j</span><span class="p">))</span>
  <span class="p">(</span><span class="k">define</span> <span class="n">rows</span> <span class="p">(</span><span class="nb">vector-length</span> <span class="n">table</span><span class="p">))</span>
  <span class="p">(</span><span class="k">define</span> <span class="n">cols</span> <span class="p">(</span><span class="nb">vector-length</span> <span class="p">(</span><span class="nb">vector-ref</span> <span class="n">table</span> <span class="mi">0</span><span class="p">)))</span>
  <span class="p">(</span><span class="k">define</span> <span class="n">next</span> <span class="nb">+</span><span class="p">)</span>
  <span class="p">(</span><span class="k">define</span> <span class="n">prev</span> <span class="nb">-</span><span class="p">)</span>
  <span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="n">lookup-sum</span> <span class="n">i</span> <span class="n">j</span><span class="p">)</span> <span class="p">(</span><span class="nb">vector-ref</span> <span class="p">(</span><span class="nb">vector-ref</span> <span class="n">table-sum</span> <span class="n">i</span><span class="p">)</span> <span class="p">(</span><span class="nb">add1</span> <span class="n">j</span><span class="p">)))</span>
  <span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="n">has-all?</span> <span class="n">r</span> <span class="n">i</span> <span class="n">j</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">=</span> <span class="p">(</span><span class="nb">+</span> <span class="n">j</span> <span class="p">(</span><span class="nb">-</span> <span class="n">i</span><span class="p">)</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="nb">-</span> <span class="p">(</span><span class="n">lookup-sum</span> <span class="n">r</span> <span class="n">j</span><span class="p">)</span> <span class="p">(</span><span class="n">lookup-sum</span> <span class="n">r</span> <span class="p">(</span><span class="nb">sub1</span> <span class="n">i</span><span class="p">)))))</span>

  <span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="n">get-hmove</span> <span class="n">c</span> <span class="n">dir</span> <span class="n">change</span><span class="p">)</span>
    <span class="p">(</span><span class="k">define</span> <span class="n">maybe-c</span> <span class="p">(</span><span class="n">change</span> <span class="n">c</span> <span class="n">dir</span><span class="p">))</span>
    <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="k">or</span> <span class="p">(</span><span class="nb">&lt;</span> <span class="n">maybe-c</span> <span class="mi">0</span><span class="p">)</span> <span class="p">(</span><span class="nb">&gt;=</span> <span class="n">maybe-c</span> <span class="n">cols</span><span class="p">))</span>
        <span class="p">(</span><span class="nb">values</span> <span class="n">c</span> <span class="p">(</span><span class="nb">-</span> <span class="n">dir</span><span class="p">))</span>
        <span class="p">(</span><span class="nb">values</span> <span class="n">maybe-c</span> <span class="n">dir</span><span class="p">)))</span>

  <span class="p">(</span><span class="k">define</span> <span class="n">calc1</span>
    <span class="p">(</span><span class="n">memoize</span>
     <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="n">r</span> <span class="n">c</span> <span class="n">dir</span><span class="p">)</span>
       <span class="p">(</span><span class="k">cond</span>
         <span class="p">[(</span><span class="nb">zero?</span> <span class="n">r</span><span class="p">)</span> <span class="mi">1</span><span class="p">]</span>
         <span class="p">[</span><span class="k">else</span>
          <span class="p">(</span><span class="k">define</span> <span class="n">cell</span> <span class="p">(</span><span class="n">lookup</span> <span class="n">r</span> <span class="n">c</span><span class="p">))</span>
          <span class="p">(</span><span class="k">define</span> <span class="n">from-up</span>
            <span class="p">(</span><span class="k">cond</span>
              <span class="p">[(</span><span class="nb">=</span> <span class="n">SPACE</span> <span class="p">(</span><span class="n">lookup</span> <span class="p">(</span><span class="nb">sub1</span> <span class="n">r</span><span class="p">)</span> <span class="n">c</span><span class="p">))</span> <span class="p">(</span><span class="n">calc1</span> <span class="p">(</span><span class="nb">sub1</span> <span class="n">r</span><span class="p">)</span> <span class="n">c</span> <span class="n">dir</span><span class="p">)]</span>
              <span class="p">[</span><span class="k">else</span> <span class="mi">0</span><span class="p">]))</span>
          <span class="p">(</span><span class="k">define-values</span> <span class="p">(</span><span class="n">p-c</span> <span class="n">p-dir</span><span class="p">)</span> <span class="p">(</span><span class="n">get-hmove</span> <span class="n">c</span> <span class="n">dir</span> <span class="n">prev</span><span class="p">))</span>
          <span class="p">(</span><span class="k">define</span> <span class="n">from-adj</span>
            <span class="p">(</span><span class="k">cond</span>
              <span class="p">[(</span><span class="nb">member</span> <span class="p">(</span><span class="n">lookup</span> <span class="n">r</span> <span class="n">p-c</span><span class="p">)</span> <span class="p">(</span><span class="nb">list</span> <span class="n">SPACE</span> <span class="n">WIN</span> <span class="n">LOSE</span><span class="p">))</span> <span class="mi">0</span><span class="p">]</span> <span class="c1">; can&#39;t come from these ways</span>
              <span class="p">[</span><span class="k">else</span> <span class="p">(</span><span class="n">calc1</span> <span class="n">r</span> <span class="n">p-c</span> <span class="n">p-dir</span><span class="p">)]))</span>
          <span class="p">(</span><span class="nb">+</span> <span class="n">from-up</span> <span class="n">from-adj</span><span class="p">)]))))</span>

  <span class="p">(</span><span class="k">define</span> <span class="n">win?</span>
    <span class="p">(</span><span class="n">memoize</span>
     <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="n">r</span> <span class="n">c</span> <span class="n">dir</span><span class="p">)</span>
       <span class="p">(</span><span class="k">match</span> <span class="p">(</span><span class="n">lookup</span> <span class="n">r</span> <span class="n">c</span><span class="p">)</span>
         <span class="p">[(</span><span class="n">?</span> <span class="p">(</span><span class="nb">curry</span> <span class="nb">equal?</span> <span class="n">WIN</span><span class="p">))</span> <span class="no">#t</span><span class="p">]</span>
         <span class="p">[(</span><span class="n">?</span> <span class="p">(</span><span class="nb">curry</span> <span class="nb">equal?</span> <span class="n">LOSE</span><span class="p">))</span> <span class="no">#f</span><span class="p">]</span>
         <span class="p">[(</span><span class="n">?</span> <span class="p">(</span><span class="nb">curry</span> <span class="nb">equal?</span> <span class="n">SPACE</span><span class="p">))</span> <span class="p">(</span><span class="n">win?</span> <span class="p">(</span><span class="nb">add1</span> <span class="n">r</span><span class="p">)</span> <span class="n">c</span> <span class="n">dir</span><span class="p">)]</span>
         <span class="p">[</span><span class="k">else</span>
          <span class="p">(</span><span class="k">define-values</span> <span class="p">(</span><span class="n">p-c</span> <span class="n">p-dir</span><span class="p">)</span> <span class="p">(</span><span class="n">get-hmove</span> <span class="n">c</span> <span class="n">dir</span> <span class="n">next</span><span class="p">))</span>
          <span class="p">(</span><span class="n">win?</span> <span class="n">r</span> <span class="n">p-c</span> <span class="n">p-dir</span><span class="p">)]))))</span>

  <span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="n">delta-from-remove</span> <span class="n">r</span> <span class="n">c</span> <span class="n">dir</span><span class="p">)</span>
    <span class="p">(</span><span class="k">cond</span>
      <span class="p">[(</span><span class="nb">not</span> <span class="p">(</span><span class="nb">=</span> <span class="n">BLOCK</span> <span class="p">(</span><span class="n">lookup</span> <span class="n">r</span> <span class="n">c</span><span class="p">)))</span> <span class="mi">0</span><span class="p">]</span>
      <span class="p">[</span><span class="k">else</span>
       <span class="p">(</span><span class="k">define</span> <span class="n">proc</span>
         <span class="p">(</span><span class="k">cond</span>
           <span class="p">[(</span><span class="k">and</span> <span class="p">(</span><span class="n">win?</span> <span class="p">(</span><span class="nb">add1</span> <span class="n">r</span><span class="p">)</span> <span class="n">c</span> <span class="n">dir</span><span class="p">)</span> <span class="p">(</span><span class="nb">not</span> <span class="p">(</span><span class="n">win?</span> <span class="n">r</span> <span class="n">c</span> <span class="n">dir</span><span class="p">)))</span> <span class="nb">+</span><span class="p">]</span>
           <span class="p">[(</span><span class="k">and</span> <span class="p">(</span><span class="nb">not</span> <span class="p">(</span><span class="n">win?</span> <span class="p">(</span><span class="nb">add1</span> <span class="n">r</span><span class="p">)</span> <span class="n">c</span> <span class="n">dir</span><span class="p">))</span> <span class="p">(</span><span class="n">win?</span> <span class="n">r</span> <span class="n">c</span> <span class="n">dir</span><span class="p">))</span> <span class="nb">-</span><span class="p">]</span>
           <span class="p">[</span><span class="k">else</span> <span class="no">#f</span><span class="p">]))</span>
       <span class="p">(</span><span class="k">cond</span>
         <span class="p">[</span><span class="n">proc</span>
          <span class="p">(</span><span class="k">define</span> <span class="n">over-calc</span>
            <span class="p">(</span><span class="k">cond</span>
              <span class="p">[(</span><span class="k">and</span> <span class="p">(</span><span class="nb">=</span> <span class="n">dir</span> <span class="mi">-1</span><span class="p">)</span> <span class="p">(</span><span class="n">has-all?</span> <span class="n">r</span> <span class="n">c</span> <span class="p">(</span><span class="nb">sub1</span> <span class="n">cols</span><span class="p">)))</span> <span class="p">(</span><span class="n">calc1</span> <span class="n">r</span> <span class="n">c</span> <span class="mi">1</span><span class="p">)]</span>
              <span class="p">[(</span><span class="k">and</span> <span class="p">(</span><span class="nb">=</span> <span class="n">dir</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="n">has-all?</span> <span class="n">r</span> <span class="mi">0</span> <span class="n">c</span><span class="p">))</span> <span class="p">(</span><span class="n">calc1</span> <span class="n">r</span> <span class="n">c</span> <span class="mi">-1</span><span class="p">)]</span>
              <span class="p">[</span><span class="k">else</span> <span class="mi">0</span><span class="p">]))</span>
          <span class="p">(</span><span class="n">proc</span> <span class="p">(</span><span class="nb">-</span> <span class="p">(</span><span class="n">calc1</span> <span class="n">r</span> <span class="n">c</span> <span class="n">dir</span><span class="p">)</span> <span class="n">over-calc</span><span class="p">))]</span>
         <span class="p">[</span><span class="k">else</span> <span class="mi">0</span><span class="p">])]))</span>
  <span class="p">(</span><span class="k">define-values</span> <span class="p">(</span><span class="n">first-sol</span><span class="p">)</span>
    <span class="p">(</span><span class="k">for/fold</span> <span class="p">([</span><span class="n">sum</span> <span class="mi">0</span><span class="p">])</span> <span class="p">([</span><span class="n">c</span> <span class="p">(</span><span class="nb">in-range</span> <span class="n">cols</span><span class="p">)])</span>
      <span class="p">(</span><span class="nb">values</span> <span class="p">(</span><span class="nb">+</span> <span class="n">sum</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">=</span> <span class="n">WIN</span> <span class="p">(</span><span class="n">lookup</span> <span class="p">(</span><span class="nb">sub1</span> <span class="n">rows</span><span class="p">)</span> <span class="n">c</span><span class="p">))</span>
                         <span class="p">(</span><span class="nb">+</span> <span class="p">(</span><span class="n">calc1</span> <span class="p">(</span><span class="nb">sub1</span> <span class="n">rows</span><span class="p">)</span> <span class="n">c</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="n">calc1</span> <span class="p">(</span><span class="nb">sub1</span> <span class="n">rows</span><span class="p">)</span> <span class="n">c</span> <span class="mi">-1</span><span class="p">))</span>
                         <span class="mi">0</span><span class="p">)))))</span>
  <span class="p">(</span><span class="k">define-values</span> <span class="p">(</span><span class="n">second-sol</span><span class="p">)</span>
    <span class="p">(</span><span class="k">for/fold</span> <span class="p">([</span><span class="n">sol</span> <span class="mi">0</span><span class="p">])</span> <span class="p">([</span><span class="n">r</span> <span class="p">(</span><span class="nb">in-range</span> <span class="p">(</span><span class="nb">sub1</span> <span class="n">rows</span><span class="p">))])</span> <span class="c1">; exclude the first floor</span>
      <span class="p">(</span><span class="k">define-values</span> <span class="p">(</span><span class="n">sub-sol</span><span class="p">)</span>
        <span class="p">(</span><span class="k">for/fold</span> <span class="p">([</span><span class="n">sub-sol</span> <span class="n">sol</span><span class="p">])</span> <span class="p">([</span><span class="n">c</span> <span class="p">(</span><span class="nb">in-range</span> <span class="n">cols</span><span class="p">)])</span>
          <span class="p">(</span><span class="nb">values</span> <span class="p">(</span><span class="nb">max</span> <span class="n">sub-sol</span> <span class="p">(</span><span class="nb">+</span> <span class="p">(</span><span class="n">delta-from-remove</span> <span class="n">r</span> <span class="n">c</span> <span class="mi">-1</span><span class="p">)</span> <span class="p">(</span><span class="n">delta-from-remove</span> <span class="n">r</span> <span class="n">c</span> <span class="mi">1</span><span class="p">))))))</span>
      <span class="p">(</span><span class="nb">values</span> <span class="p">(</span><span class="nb">max</span> <span class="n">sol</span> <span class="n">sub-sol</span><span class="p">))))</span>
  <span class="p">(</span><span class="nb">values</span> <span class="n">first-sol</span> <span class="p">(</span><span class="nb">+</span> <span class="n">first-sol</span> <span class="n">second-sol</span><span class="p">)))</span>

<span class="p">(</span><span class="n">calc</span> <span class="o">&#39;</span><span class="p">(</span><span class="s2">"#####.###.##"</span>
        <span class="s2">"###.#####.##"</span>
        <span class="s2">"#.####.#####"</span>
        <span class="s2">"@##$########"</span><span class="p">))</span>
</pre></div></td></tr></tbody></table></div><p>results in:</p><div class="highlight"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span></span>20
24
</pre></div></td></tr></tbody></table></div></!></div><hr/></!></!>
  </section>
</body>
</html>